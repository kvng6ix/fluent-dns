<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🎨 Fluent DNS - Premium Domain Service</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-purple: #8b5cf6;
            --dark-purple: #6d28d9;
            --light-purple: #a78bfa;
            --accent-purple: #c084fc;
            --black: #0f0f0f;
            --dark-gray: #1a1a1a;
            --medium-gray: #2d2d2d;
            --light-gray: #404040;
            --text-white: #ffffff;
            --text-gray: #a1a1aa;
            --success: #10b981;
            --error: #ef4444;
            --warning: #f59e0b;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--black) 0%, var(--dark-gray) 50%, var(--dark-purple) 100%);
            min-height: 100vh;
            color: var(--text-white);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header Styles */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            background: rgba(139, 92, 246, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 25px 30px;
            border: 1px solid rgba(139, 92, 246, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .logo {
            font-size: 2.5em;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary-purple), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 30px rgba(139, 92, 246, 0.5);
        }

        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .connect-btn {
            background: linear-gradient(135deg, var(--primary-purple), var(--dark-purple));
            color: var(--text-white);
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(139, 92, 246, 0.3);
        }

        .connect-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(139, 92, 246, 0.4);
        }

        .connect-btn:disabled {
            background: var(--medium-gray);
            cursor: not-allowed;
            transform: none;
        }

        .disconnect-btn {
            background: linear-gradient(135deg, var(--error), #dc2626);
            color: var(--text-white);
            border: none;
            padding: 12px 20px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(239, 68, 68, 0.3);
        }

        .disconnect-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(239, 68, 68, 0.4);
        }

        /* Stats Section */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: rgba(26, 26, 26, 0.8);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 30px;
            border: 1px solid rgba(139, 92, 246, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            position: relative;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            border-color: var(--primary-purple);
            box-shadow: 0 12px 40px rgba(139, 92, 246, 0.2);
        }

        .stat-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
        }

        .stat-icon {
            font-size: 24px;
            opacity: 0.8;
        }

        .stat-title {
            font-size: 14px;
            color: var(--text-gray);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 2.8em;
            font-weight: 700;
            background: linear-gradient(135deg, var(--text-white), var(--light-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .stat-change {
            font-size: 12px;
            color: var(--success);
            font-weight: 500;
        }

        .last-updated {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 10px;
            color: var(--text-gray);
            opacity: 0.7;
        }

        /* Recent Domains */
        .recent-domains {
            max-height: 300px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--primary-purple) var(--dark-gray);
        }

        .recent-domains::-webkit-scrollbar {
            width: 6px;
        }

        .recent-domains::-webkit-scrollbar-track {
            background: var(--dark-gray);
            border-radius: 3px;
        }

        .recent-domains::-webkit-scrollbar-thumb {
            background: var(--primary-purple);
            border-radius: 3px;
        }

        .domain-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(139, 92, 246, 0.1);
            transition: all 0.2s ease;
        }

        .domain-item:hover {
            padding-left: 10px;
            background: rgba(139, 92, 246, 0.05);
            margin: 0 -10px;
            border-radius: 8px;
        }

        .domain-info {
            display: flex;
            flex-direction: column;
            flex: 1;
        }

        .domain-name {
            font-weight: 600;
            color: var(--accent-purple);
            font-size: 14px;
        }

        .domain-owner {
            font-size: 12px;
            color: var(--text-gray);
            margin-top: 2px;
        }

        .domain-price {
            color: var(--success);
            font-size: 13px;
            font-weight: 500;
        }

        /* Refresh Button */
        .refresh-btn {
            background: rgba(139, 92, 246, 0.2);
            border: 1px solid var(--primary-purple);
            color: var(--primary-purple);
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }

        .refresh-btn:hover:not(:disabled) {
            background: rgba(139, 92, 246, 0.3);
            transform: translateY(-1px);
        }

        .refresh-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Main Content Grid */
        .main-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }

        /* Feature Boxes Grid */
        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }

        .feature-box {
            background: rgba(26, 26, 26, 0.8);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 35px;
            border: 1px solid rgba(139, 92, 246, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .feature-box:hover {
            transform: translateY(-4px);
            border-color: var(--primary-purple);
            box-shadow: 0 12px 40px rgba(139, 92, 246, 0.2);
        }

        .section-title {
            font-size: 1.8em;
            font-weight: 700;
            margin-bottom: 25px;
            background: linear-gradient(135deg, var(--text-white), var(--light-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .section-icon {
            font-size: 1.2em;
            opacity: 0.8;
        }

        /* Wallet Info */
        .wallet-info {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(109, 40, 217, 0.1));
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 25px;
            border: 1px solid rgba(139, 92, 246, 0.3);
        }

        .wallet-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .wallet-label {
            color: var(--text-gray);
            font-size: 14px;
        }

        .wallet-value {
            color: var(--text-white);
            font-weight: 600;
        }

        /* Pricing Tiers */
        .pricing-section {
            margin-bottom: 30px;
        }

        .pricing-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }

        .tier {
            background: linear-gradient(135deg, var(--primary-purple), var(--dark-purple));
            color: var(--text-white);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .tier:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.4);
        }

        .tier-badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 12px;
            display: inline-block;
        }

        .tier-price {
            font-size: 1.5em;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .tier-length {
            opacity: 0.9;
            font-size: 13px;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 25px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-white);
            font-size: 14px;
        }

        .form-input {
            width: 100%;
            padding: 16px 20px;
            background: var(--medium-gray);
            border: 2px solid rgba(139, 92, 246, 0.3);
            border-radius: 12px;
            color: var(--text-white);
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-purple);
            background: rgba(139, 92, 246, 0.1);
            box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.1);
        }

        .form-input::placeholder {
            color: var(--text-gray);
        }

        .price-display {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.1));
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            border-left: 4px solid var(--success);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .price-text {
            font-weight: 600;
            color: var(--text-white);
        }

        .price-value {
            font-size: 1.2em;
            font-weight: 700;
            color: var(--success);
        }

        /* Action Buttons */
        .button-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .btn {
            background: linear-gradient(135deg, var(--primary-purple), var(--dark-purple));
            color: var(--text-white);
            border: none;
            padding: 14px 24px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.2);
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.3);
        }

        .btn:disabled {
            background: var(--medium-gray);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: transparent;
            border: 2px solid var(--primary-purple);
        }

        .btn-secondary:hover:not(:disabled) {
            background: rgba(139, 92, 246, 0.1);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning), #d97706);
        }

        .btn-warning:hover:not(:disabled) {
            box-shadow: 0 8px 25px rgba(245, 158, 11, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--error), #dc2626);
        }

        .btn-danger:hover:not(:disabled) {
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.3);
        }

        /* Status Messages */
        .status {
            margin: 20px 0;
            padding: 16px 20px;
            border-radius: 12px;
            font-weight: 500;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .status.success {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid var(--success);
            color: var(--success);
        }

        .status.error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--error);
            color: var(--error);
        }

        .status.warning {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid var(--warning);
            color: var(--warning);
        }

        /* Result Display Boxes */
        .result-box {
            background: rgba(139, 92, 246, 0.05);
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }

        .result-header {
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--accent-purple);
            font-size: 1.1em;
        }

        .result-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px solid rgba(139, 92, 246, 0.1);
        }

        .result-row:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .result-label {
            color: var(--text-gray);
            font-size: 14px;
        }

        .result-value {
            color: var(--text-white);
            font-weight: 600;
            font-family: monospace;
            font-size: 13px;
        }

        .copy-btn {
            background: rgba(139, 92, 246, 0.2);
            border: none;
            color: var(--accent-purple);
            padding: 4px 8px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 8px;
            transition: all 0.2s ease;
        }

        .copy-btn:hover {
            background: rgba(139, 92, 246, 0.4);
        }

        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(139, 92, 246, 0.3);
            border-top: 2px solid var(--primary-purple);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-large {
            width: 30px;
            height: 30px;
            border-width: 3px;
        }

        /* Connection Status Indicator */
        .connection-status {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .connection-status.connected {
            background: var(--success);
            animation: pulse 2s infinite;
        }

        .connection-status.disconnected {
            background: var(--error);
        }

        /* Footer */
        .footer {
            margin-top: auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 30px 0;
            border-top: 1px solid rgba(139, 92, 246, 0.2);
        }

        .footer a {
            color: var(--accent-purple);
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .footer a:hover {
            color: var(--text-white);
            text-shadow: 0 0 10px rgba(139, 92, 246, 0.5);
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .features-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .header {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }

            .logo {
                font-size: 2em;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .pricing-grid {
                grid-template-columns: 1fr;
            }

            .features-grid {
                grid-template-columns: 1fr;
            }

            .feature-box {
                padding: 25px;
            }

            .button-group {
                flex-direction: column;
            }

            .footer {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        /* Error State */
        .error-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-gray);
        }

        .error-state .icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .retry-btn {
            background: rgba(139, 92, 246, 0.2);
            border: 1px solid var(--primary-purple);
            color: var(--primary-purple);
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            margin-top: 15px;
            transition: all 0.3s ease;
        }

        .retry-btn:hover {
            background: rgba(139, 92, 246, 0.3);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="logo">🎨 Fluent DNS</div>
            <div class="header-actions">
                <button id="networkStatus" class="btn btn-secondary" style="font-size: 12px;">
                    <span class="connection-status disconnected"></span>Fluent Testnet
                </button>
                <button id="connectWallet" class="connect-btn">Connect Wallet</button>
                <button id="disconnectWallet" class="disconnect-btn" style="display: none;">Disconnect</button>
            </div>
        </header>

        <!-- Statistics Grid -->
        <section class="stats-grid">
            <div class="stat-card">
                <div class="last-updated" id="statsLastUpdated">Never</div>
                <div class="stat-header">
                    <span class="stat-icon">🏷️</span>
                    <div class="stat-title">Total Domains Minted</div>
                </div>
                <div class="stat-value" id="totalDomains">
                    <div class="loading loading-large"></div>
                </div>
                <div class="stat-change" id="domainsChange">Loading...</div>
                <button class="refresh-btn" id="refreshStats">🔄 Refresh Stats</button>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-icon">💰</span>
                    <div class="stat-title">Total ETH Locked</div>
                </div>
                <div class="stat-value" id="totalEthLocked">
                    <div class="loading loading-large"></div>
                </div>
                <div class="stat-change">Value locked in contract</div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-icon">📈</span>
                    <div class="stat-title">Recent Activity</div>
                </div>
                <div class="recent-domains" id="recentDomains">
                    <div style="text-align: center; padding: 40px;">
                        <div class="loading loading-large"></div>
                        <div style="margin-top: 10px; color: var(--text-gray);">Loading live data...</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Wallet Connection Info -->
        <div id="walletInfo" class="wallet-info" style="display: none;">
            <div class="wallet-row">
                <span class="wallet-label">Connected Wallet:</span>
                <span class="wallet-value" id="walletAddress"></span>
            </div>
            <div class="wallet-row">
                <span class="wallet-label">Balance:</span>
                <span class="wallet-value" id="walletBalance">0.0000 ETH</span>
            </div>
            <div class="wallet-row">
                <span class="wallet-label">Network:</span>
                <span class="wallet-value" id="networkName">Fluent Testnet</span>
            </div>
        </div>

        <!-- Pricing Display -->
        <div class="pricing-section">
            <h3 style="margin-bottom: 15px; color: var(--text-white); text-align: center;">💎 Dynamic Pricing</h3>
            <div class="pricing-grid">
                <div class="tier">
                    <div class="tier-badge">Premium</div>
                    <div class="tier-price">0.01 ETH</div>
                    <div class="tier-length">1-5 characters</div>
                </div>
                <div class="tier">
                    <div class="tier-badge">Standard</div>
                    <div class="tier-price">0.005 ETH</div>
                    <div class="tier-length">6-10 characters</div>
                </div>
                <div class="tier">
                    <div class="tier-badge">Economy</div>
                    <!-- Feature Boxes Grid -->
        <div class="features-grid">
            <!-- Register Domain Box -->
            <div class="feature-box">
                <h2 class="section-title">
                    <span class="section-icon">🚀</span>
                    Register Domain
                </h2>

                <div class="form-group">
                    <label for="domainName" class="form-label">
                        Domain Name <span style="color: var(--text-gray);">(3-50 characters: a-z, 0-9, '-' only)</span>
                    </label>
                    <input type="text" id="domainName" class="form-input" placeholder="Enter your desired domain name">
                </div>

                <div class="form-group">
                    <label for="targetAddress" class="form-label">
                        Target Address <span style="color: var(--text-gray);">(optional - defaults to your wallet)</span>
                    </label>
                    <input type="text" id="targetAddress" class="form-input" placeholder="0x... (leave empty to use your address)">
                </div>

                <div class="price-display" id="priceDisplayContainer" style="display: none;">
                    <div class="price-text">Registration Price:</div>
                    <div class="price-value" id="priceDisplay"></div>
                </div>

                <div id="registerStatus"></div>

                <div class="button-group">
                    <button id="checkAvailabilityBtn" class="btn btn-secondary">🔍 Check Availability</button>
                    <button id="registerBtn" class="btn" disabled>🚀 Register Domain</button>
                </div>
            </div>

            <!-- Domain Ownership Checker -->
            <div class="feature-box">
                <h2 class="section-title">
                    <span class="section-icon">👤</span>
                    Domain Ownership Checker
                </h2>

                <div class="form-group">
                    <label for="ownershipDomain" class="form-label">
                        Enter Domain to Check Ownership
                    </label>
                    <input type="text"
                    <div class="tier-price">0.001 ETH</div>
                    <div class="tier-length">11+ characters</div>
                </div>
            </div>
        </div>
                
        <!-- Ethers.js Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.1/ethers.umd.min.js"></script>
    <script>
// Contract Configuration
const CONTRACT_ADDRESS = "0xF273cd4154D56d50FF32b09A224Cdc2F269b3acA";
const DEPLOYMENT_BLOCK = 3994017;

// Enhanced ABI with all functions
const CONTRACT_ABI = [
    "function register(string calldata name, address target) external payable",
    "function available(string calldata name) external view returns (bool)",
    "function getPrice(string calldata name) external view returns (uint256)",
    "function ownerOf(string calldata name) external view returns (address)",
    "function resolve(string calldata name) external view returns (address)",
    "function transferName(string calldata name, address newOwner) external",
    "function setAddress(string calldata name, address target) external",
    "function premiumPrice() external view returns (uint256)",
    "function standardPrice() external view returns (uint256)",
    "function economyPrice() external view returns (uint256)",
    "function batchRegister(string[] calldata names, address[] calldata targets) external payable",
    "event Registered(string name, address indexed owner, address target, uint256 price)",
    "event AddressSet(string name, address indexed target)",
    "event OwnershipTransferred(string name, address indexed oldOwner, address indexed newOwner)"
];

// Fluent Testnet Configuration
const FLUENT_TESTNET = {
    chainId: '0x5202',
    chainName: 'Fluent Testnet',
    nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 },
    rpcUrls: ['https://rpc.testnet.fluent.xyz/'],
    blockExplorerUrls: ['https://testnet.fluentscan.xyz/']
};

// Global State
let provider = null;
let signer = null;
let contract = null;
let userAddress = null;
let statsCache = { data: null, timestamp: 0 };
const CACHE_DURATION = 30000; // 30 seconds

// Utility Functions
function showStatus(elementId, message, type = 'success', duration = 5000) {
    const element = document.getElementById(elementId);
    element.innerHTML = `<div class="status ${type}">${message}</div>`;
    if (duration > 0) {
        setTimeout(() => element.innerHTML = '', duration);
    }
}

function formatAddress(address) {
    if (!address || address === ethers.ZeroAddress) return 'Not set';
    return `${address.slice(0, 6)}...${address.slice(-4)}`;
}

function calculatePrice(domainName) {
    if (!domainName) return null;
    const length = domainName.length;
    if (length <= 5) return '0.01';
    if (length <= 10) return '0.005';
    return '0.001';
}

function isValidDomainName(name) {
    if (!name || name.length < 3 || name.length > 50) return false;
    return /^[a-z0-9-]+$/.test(name);
}

function createCopyButton(text) {
    return `<button class="copy-btn" onclick="copyToClipboard('${text}')">📋</button>`;
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        showStatus('lookupStatus', '📋 Address copied to clipboard!', 'success', 2000);
    });
}

function updateLastUpdated() {
    const now = new Date();
    document.getElementById('statsLastUpdated').textContent = now.toLocaleTimeString();
}

function updateNetworkStatus(connected = false) {
    const statusElement = document.getElementById('networkStatus');
    const indicator = statusElement.querySelector('.connection-status');
    
    if (connected) {
        indicator.className = 'connection-status connected';
        statusElement.innerHTML = '<span class="connection-status connected"></span>Fluent Testnet';
    } else {
        indicator.className = 'connection-status disconnected';
        statusElement.innerHTML = '<span class="connection-status disconnected"></span>Fluent Testnet';
    }
}

// Wallet Connection
async function connectWallet() {
    try {
        if (typeof window.ethereum === 'undefined') {
            showStatus('registerStatus', '❌ Please install MetaMask or another Web3 wallet', 'error');
            return;
        }

        document.getElementById('connectWallet').innerHTML = '<span class="loading"></span> Connecting...';
        document.getElementById('connectWallet').disabled = true;

        await window.ethereum.request({ method: 'eth_requestAccounts' });
        provider = new ethers.BrowserProvider(window.ethereum);

        const network = await provider.getNetwork();
        if (network.chainId !== 20994n) {
            await switchToFluentTestnet();
        }

        signer = await provider.getSigner();
        userAddress = await signer.getAddress();
        contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

        // Update UI
        document.getElementById('connectWallet').style.display = 'none';
        document.getElementById('disconnectWallet').style.display = 'block';
        document.getElementById('registerBtn').disabled = false;
        
        updateNetworkStatus(true);

        // Show wallet info
        document.getElementById('walletAddress').textContent = formatAddress(userAddress);
        const balance = await provider.getBalance(userAddress);
        document.getElementById('walletBalance').textContent = `${parseFloat(ethers.formatEther(balance)).toFixed(4)} ETH`;
        document.getElementById('walletInfo').style.display = 'block';

        showStatus('registerStatus', '✅ Wallet connected successfully!', 'success');
        
    } catch (error) {
        console.error('Error connecting wallet:', error);
        showStatus('registerStatus', '❌ Failed to connect wallet: ' + error.message, 'error');
        document.getElementById('connectWallet').innerHTML = 'Connect Wallet';
        document.getElementById('connectWallet').disabled = false;
    }
}

async function disconnectWallet() {
    provider = null;
    signer = null;
    contract = null;
    userAddress = null;
    
    document.getElementById('connectWallet').style.display = 'block';
    document.getElementById('connectWallet').innerHTML = 'Connect Wallet';
    document.getElementById('connectWallet').disabled = false;
    document.getElementById('disconnectWallet').style.display = 'none';
    document.getElementById('registerBtn').disabled = true;
    document.getElementById('walletInfo').style.display = 'none';
    
    updateNetworkStatus(false);
    showStatus('registerStatus', '👋 Wallet disconnected', 'warning', 3000);
}

async function switchToFluentTestnet() {
    try {
        await window.ethereum.request({
            method: 'wallet_switchEthereumChain',
            params: [{ chainId: FLUENT_TESTNET.chainId }],
        });
    } catch (switchError) {
        if (switchError.code === 4902) {
            await window.ethereum.request({
                method: 'wallet_addEthereumChain',
                params: [FLUENT_TESTNET],
            });
        } else {
            throw switchError;
        }
    }
}

// Enhanced Stats Loading with Better Error Handling
async function loadStats(forceRefresh = false) {
    try {
        // Check cache first
        const now = Date.now();
        if (!forceRefresh && statsCache.data && (now - statsCache.timestamp) < CACHE_DURATION) {
            displayStats(statsCache.data);
            return;
        }

        const refreshBtn = document.getElementById('refreshStats');
        if (refreshBtn) {
            refreshBtn.innerHTML = '<span class="loading"></span> Loading...';
            refreshBtn.disabled = true;
        }

        const readProvider = new ethers.JsonRpcProvider('https://rpc.testnet.fluent.xyz/');
        const readContract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, readProvider);
        
        const currentBlock = await readProvider.getBlockNumber();
        
        // Use smaller chunks and implement retry logic
        const CHUNK_SIZE = 2000;
        let allEvents = [];
        let totalEthLocked = 0n;
        
        for (let fromBlock = DEPLOYMENT_BLOCK; fromBlock <= currentBlock; fromBlock += CHUNK_SIZE) {
            const toBlock = Math.min(fromBlock + CHUNK_SIZE - 1, currentBlock);
            
            let retries = 3;
            while (retries > 0) {
                try {
                    const filter = readContract.filters.Registered();
                    const chunkEvents = await readContract.queryFilter(filter, fromBlock, toBlock);
                    allEvents = allEvents.concat(chunkEvents);
                    
                    // Calculate total ETH for this chunk
                    chunkEvents.forEach(event => {
                        if (event.args && event.args.price) {
                            totalEthLocked += event.args.price;
                        }
                    });
                    
                    break; // Success, move to next chunk
                } catch (chunkError) {
                    console.warn(`Chunk ${fromBlock}-${toBlock} attempt ${4-retries} failed:`, chunkError);
                    retries--;
                    if (retries === 0) {
                        console.error(`Failed to load chunk ${fromBlock}-${toBlock} after 3 attempts`);
                    } else {
                        await new Promise(resolve => setTimeout(resolve, 1000 * (4-retries))); // Exponential backoff
                    }
                }
            }
        }

        const statsData = {
            totalDomains: allEvents.length,
            totalEthLocked,
            recentEvents: allEvents.slice(-15).reverse(),
            timestamp: now
        };

        // Cache the results
        statsCache = { data: statsData, timestamp: now };
        
        displayStats(statsData);
        
    } catch (error) {
        console.error('Error loading stats:', error);
        displayErrorState();
    } finally {
        const refreshBtn = document.getElementById('refreshStats');
        if (refreshBtn) {
            refreshBtn.innerHTML = '🔄 Refresh Stats';
            refreshBtn.disabled = false;
        }
    }
}

function displayStats(data) {
    // Update total domains
    document.getElementById('totalDomains').textContent = data.totalDomains.toString();
    document.getElementById('domainsChange').textContent = `Since deployment`;

    // Update total ETH locked
    document.getElementById('totalEthLocked').textContent = parseFloat(ethers.formatEther(data.totalEthLocked)).toFixed(4);

    // Show recent domains with owner info
    if (data.recentEvents.length === 0) {
        document.getElementById('recentDomains').innerHTML = '<div style="text-align: center; color: var(--text-gray); padding: 20px;">No domains registered yet</div>';
    } else {
        document.getElementById('recentDomains').innerHTML = data.recentEvents.map(event => `
            <div class="domain-item">
                <div class="domain-info">
                    <div class="domain-name">${event.args.name}</div>
                    <div class="domain-owner">by ${formatAddress(event.args.owner)}</div>
                </div>
                <span class="domain-price">${ethers.formatEther(event.args.price)} ETH</span>
            </div>
        `).join('');
    }
    
    updateLastUpdated();
}

function displayErrorState() {
    document.getElementById('totalDomains').textContent = 'Error';
    document.getElementById('totalEthLocked').textContent = 'Error';
    document.getElementById('recentDomains').innerHTML = `
        <div class="error-state">
            <div class="icon">⚠️</div>
            <div>Unable to load live data</div>
            <div style="font-size: 12px; margin-top: 8px;">Network might be congested</div>
            <button class="retry-btn" onclick="loadStats(true)">Retry</button>
        </div>
    `;
}

// Domain Registration Functions
document.getElementById('domainName').addEventListener('input', (e) => {
    const domainName = e.target.value.toLowerCase();
    e.target.value = domainName;
    
    if (domainName && isValidDomainName(domainName)) {
        const price = calculatePrice(domainName);
        document.getElementById('priceDisplay').textContent = `${price} ETH`;
        document.getElementById('priceDisplayContainer').style.display = 'flex';
    } else if (domainName) {
        document.getElementById('priceDisplay').textContent = 'Invalid domain name';
        document.getElementById('priceDisplayContainer').style.display = 'flex';
    } else {
        document.getElementById('priceDisplayContainer').style.display = 'none';
    }
});

document.getElementById('checkAvailabilityBtn').addEventListener('click', async () => {
    const domainName = document.getElementById('domainName').value.toLowerCase().trim();
    
    if (!domainName) {
        showStatus('registerStatus', '⚠️ Please enter a domain name', 'warning');
        return;
    }
    
    if (!isValidDomainName(domainName)) {
        showStatus('registerStatus', '❌ Invalid domain name. Use only a-z, 0-9, and hyphens. Length: 3-50 characters.', 'error');
        return;
    }

    if (!contract) {
        showStatus('registerStatus', '⚠️ Please connect your wallet first', 'warning');
        return;
    }

    try {
        document.getElementById('checkAvailabilityBtn').innerHTML = '<span class="loading"></span> Checking...';
        document.getElementById('checkAvailabilityBtn').disabled = true;
        
        const available = await contract.available(domainName);
        if (available) {
            showStatus('registerStatus', `✅ "${domainName}" is available for registration!`, 'success');
        } else {
            showStatus('registerStatus', `❌ "${domainName}" is already taken`, 'error');
        }
    } catch (error) {
        console.error('Error checking availability:', error);
        showStatus('registerStatus', '❌ Error checking availability: ' + error.message, 'error');
    } finally {
        document.getElementById('checkAvailabilityBtn').innerHTML = '🔍 Check Availability';
        document.getElementById('checkAvailabilityBtn').disabled = false;
    }
});

document.getElementById('registerBtn').addEventListener('click', async () => {
    const domainName = document.getElementById('domainName').value.toLowerCase().trim();
    const targetAddress = document.getElementById('targetAddress').value.trim();
    
    if (!domainName) {
        showStatus('registerStatus', '⚠️ Please enter a domain name', 'warning');
        return;
    }
    
    if (!isValidDomainName(domainName)) {
        showStatus('registerStatus', '❌ Invalid domain name. Use only a-z, 0-9, and hyphens. Length: 3-50 characters.', 'error');
        return;
    }

    if (!contract) {
        showStatus('registerStatus', '⚠️ Please connect your wallet first', 'warning');
        return;
    }

    try {
        document.getElementById('registerBtn').innerHTML = '<span class="loading"></span> Registering...';
        document.getElementById('registerBtn').disabled = true;
        
        const available = await contract.available(domainName);
        if (!available) {
            showStatus('registerStatus', '❌ Domain is already taken', 'error');
            return;
        }

        const price = calculatePrice(domainName);
        const priceInWei = ethers.parseEther(price);
        
        const target = targetAddress && ethers.isAddress(targetAddress) 
            ? targetAddress 
            : ethers.ZeroAddress;

        showStatus('registerStatus', '📝 Please confirm the transaction in your wallet...', 'warning');

        const tx = await contract.register(domainName, target, {
            value: priceInWei
        });
        
        showStatus('registerStatus', '⏳ Transaction submitted. Waiting for confirmation...', 'warning');
        
        const receipt = await tx.wait();
        
        showStatus('registerStatus', `🎉 Successfully registered "${domainName}"! TX: ${receipt.hash.slice(0, 10)}...`, 'success');
        
        // Clear inputs and refresh data
        document.getElementById('domainName').value = '';
        document.getElementById('targetAddress').value = '';
        document.getElementById('priceDisplayContainer').style.display = 'none';
        
        // Refresh wallet balance and stats
        const balance = await provider.getBalance(userAddress);
        document.getElementById('walletBalance').textContent = `${parseFloat(ethers.formatEther(balance)).toFixed(4)} ETH`;
        setTimeout(() => loadStats(true), 3000);
        
    } catch (error) {
        console.error('Error registering domain:', error);
        let errorMessage = '❌ Registration failed';
        if (error.message.includes('insufficient funds')) {
            errorMessage = '💸 Insufficient funds for registration';
        } else if (error.message.includes('user rejected')) {
            errorMessage = '🚫 Transaction cancelled by user';
        }
        showStatus('registerStatus', errorMessage, 'error');
    } finally {
        document.getElementById('registerBtn').innerHTML = '🚀 Register Domain';
        document.getElementById('registerBtn').disabled = false;
    }
});

// Event Listeners
document.getElementById('connectWallet').addEventListener('click', connectWallet);
document.getElementById('disconnectWallet').addEventListener('click', disconnectWallet);
document.getElementById('refreshStats').addEventListener('click', () => loadStats(true));

// Auto-connect if previously connected
window.addEventListener('load', async () => {
    if (typeof window.ethereum !== 'undefined') {
        const accounts = await window.ethereum.request({ method: 'eth_accounts' });
        if (accounts.length > 0) {
            await connectWallet();
        }
    }
    await loadStats();
});

// Handle account/network changes
if (typeof window.ethereum !== 'undefined') {
    window.ethereum.on('accountsChanged', (accounts) => {
        if (accounts.length === 0) {
            disconnectWallet();
        } else {
            connectWallet();
        }
    });

    window.ethereum.on('chainChanged', () => {
        window.location.reload();
    });
}

// Auto-refresh stats every 60 seconds
setInterval(() => loadStats(), 60000);

// Make copyToClipboard available globally
window.copyToClipboard = copyToClipboard;
    </script>
</body>
</html>
